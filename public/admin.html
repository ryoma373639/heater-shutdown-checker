<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®¡ç†ç”»é¢ - ç¯æ²¹ã‚¹ãƒˆãƒ¼ãƒ–æ¶ˆç«ç¢ºèªã‚¢ãƒ—ãƒª</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 600px; margin: 0 auto; }
    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      padding: 30px;
      margin-bottom: 20px;
    }
    h1 { color: #667eea; margin-bottom: 10px; font-size: 24px; }
    .subtitle { color: #6b7280; margin-bottom: 20px; font-size: 14px; }
    button {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 16px;
      margin-bottom: 10px;
      transition: transform 0.2s;
    }
    button:hover { transform: scale(1.02); }
    .btn-danger { background: #ef4444; color: white; }
    .btn-warning { background: #f59e0b; color: white; }
    .btn-info { background: #3b82f6; color: white; }
    #log {
      background: #f3f4f6;
      padding: 15px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 13px;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      line-height: 1.6;
    }
    .status {
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 10px;
      font-size: 14px;
    }
    .status.success { background: #d1fae5; color: #065f46; }
    .status.warning { background: #fef3c7; color: #92400e; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="./firebase-config.js"></script>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>ğŸ”§ ç®¡ç†ç”»é¢</h1>
      <p class="subtitle">ç¯æ²¹ã‚¹ãƒˆãƒ¼ãƒ–æ¶ˆç«ç¢ºèªã‚¢ãƒ—ãƒª - ãƒ‡ãƒ¼ã‚¿ç®¡ç†</p>

      <div id="status" class="status warning">
        Firebaseæ¥ç¶šä¸­...
      </div>

      <button class="btn-danger" onclick="forceResetAll()">
        ğŸ”„ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ä»Šã™ããƒªã‚»ãƒƒãƒˆ
      </button>

      <button class="btn-warning" onclick="selectiveReset()">
        âš¡ æ‰‹å‹•ãƒªã‚»ãƒƒãƒˆ
      </button>

      <button class="btn-info" onclick="checkStatus()">
        ğŸ“Š ç¾åœ¨ã®çŠ¶æ…‹ã‚’ç¢ºèª
      </button>
    </div>

    <div class="card">
      <h2 style="margin-bottom: 15px; font-size: 18px;">ğŸ“ ãƒ­ã‚°</h2>
      <div id="log">ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™...</div>
    </div>
  </div>

  <script>
    let db = null;

    function log(msg, isError = false) {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString('ja-JP');
      const prefix = isError ? 'âŒ' : 'âœ…';
      logDiv.textContent += `[${timestamp}] ${prefix} ${msg}\n`;
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(msg);
    }

    function updateStatus(msg, isSuccess = true) {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = msg;
      statusDiv.className = 'status ' + (isSuccess ? 'success' : 'warning');
    }

    // FirebaseåˆæœŸåŒ–
    if (typeof initFirebase === 'function') {
      initFirebase();
      if (typeof getDatabase === 'function') {
        db = getDatabase();
        updateStatus('âœ… Firebaseæ¥ç¶šæˆåŠŸ');
        log('FirebaseåˆæœŸåŒ–å®Œäº†');
      }
    }

    async function forceResetAll() {
      if (!confirm('æœ¬å½“ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\n\nãƒ»å…¨å·¥å ´ã®ç¤¾å“¡ãƒªã‚¹ãƒˆãŒå‰Šé™¤ã•ã‚Œã¾ã™\nãƒ»ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã™\nãƒ»ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“')) {
        return;
      }

      log('ğŸ”„ å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆé–‹å§‹...');
      updateStatus('ğŸ”„ ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œä¸­...', false);

      try {
        // å…¨å·¥å ´ã‚’ãƒªã‚»ãƒƒãƒˆ
        const factoryNames = ['ç¬¬ä¸€å·¥å ´', 'ç¬¬äºŒå·¥å ´', 'ç¬¬ä¸‰å·¥å ´', 'ç¬¬å››å·¥å ´'];
        for (let i = 0; i < 4; i++) {
          // Firebase
          if (db) {
            await db.ref('factories/' + i + '/employees').set([]);
            log(`Firebase: ${factoryNames[i]}ã‚’ãƒªã‚»ãƒƒãƒˆ`);
          }

          // localStorage
          localStorage.removeItem('heater-employees-' + i);
          log(`localStorage: ${factoryNames[i]}ã‚’ã‚¯ãƒªã‚¢`);
        }

        // ãƒªã‚»ãƒƒãƒˆæ™‚åˆ»ã‚’å‰Šé™¤ï¼ˆå†ãƒªã‚»ãƒƒãƒˆã‚’è¨±å¯ï¼‰
        localStorage.removeItem('heater-last-reset');
        if (db) {
          await db.ref('settings/lastReset').remove();
        }
        log('ãƒªã‚»ãƒƒãƒˆæ™‚åˆ»è¨˜éŒ²ã‚’å‰Šé™¤');

        updateStatus('âœ… ãƒªã‚»ãƒƒãƒˆå®Œäº†ï¼', true);
        log('âœ… å…¨ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚»ãƒƒãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ');
        log('ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„');

        setTimeout(() => {
          if (confirm('ãƒªã‚»ãƒƒãƒˆå®Œäº†ã—ã¾ã—ãŸã€‚\n\nãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚’é–‹ãã¾ã™ã‹ï¼Ÿ')) {
            window.open('./index.html', '_blank');
          }
        }, 1000);

      } catch (error) {
        log('ã‚¨ãƒ©ãƒ¼: ' + error.message, true);
        updateStatus('âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', false);
      }
    }

    async function selectiveReset() {
      if (!confirm('æ‰‹å‹•ãƒªã‚»ãƒƒãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã‹?\n\n[å®Ÿè¡Œå†…å®¹]\nãƒ»å…¨ã¦ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ\nãƒ»ã€Œå†ä½¿ç”¨ã€ãƒœã‚¿ãƒ³ã§è¿½åŠ ã—ãŸç¤¾å“¡ã‚’å‰Šé™¤\nãƒ»ã€Œè¿½åŠ ã€ãƒœã‚¿ãƒ³ã§è¿½åŠ ã—ãŸç¤¾å“¡ã¯æ®‹ã™\n\nâ€»AM3æ™‚ã®è‡ªå‹•ãƒªã‚»ãƒƒãƒˆã¨åŒã˜å‡¦ç†ã§ã™')) {
        return;
      }

      log('[æ‰‹å‹•ãƒªã‚»ãƒƒãƒˆ] é–‹å§‹...');
      updateStatus('ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œä¸­...', false);

      try {
        const factoryNames = ['ç¬¬ä¸€å·¥å ´', 'ç¬¬äºŒå·¥å ´', 'ç¬¬ä¸‰å·¥å ´', 'ç¬¬å››å·¥å ´'];
        let totalDeleted = 0;
        let totalKept = 0;

        for (let i = 0; i < 4; i++) {
          // localStorageã‹ã‚‰ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
          const key = 'heater-employees-' + i;
          const data = localStorage.getItem(key);
          const employees = data ? JSON.parse(data) : [];

          log(`\nã€${factoryNames[i]}ã€‘å‡¦ç†é–‹å§‹ (ç¾åœ¨${employees.length}å)`);

          const resetEmployees = [];
          let deleted = 0;
          let kept = 0;

          // typeãŒ'temporary'ã®ç¤¾å“¡ã®ã¿å‰Šé™¤ã€ãã‚Œä»¥å¤–ã¯æ®‹ã™
          for (let j = 0; j < employees.length; j++) {
            const emp = employees[j];
            if (emp.type === 'temporary') {
              deleted++;
              log(`  [å‰Šé™¤] ${emp.name} (å†ä½¿ç”¨ãƒœã‚¿ãƒ³ã§ç™»éŒ²)`);
            } else {
              emp.checked = false; // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
              resetEmployees.push(emp);
              kept++;
              const typeLabel = emp.type === 'permanent' ? 'è¿½åŠ ãƒœã‚¿ãƒ³' : 'æ—¢å­˜ãƒ‡ãƒ¼ã‚¿';
              log(`  [ä¿æŒ] ${emp.name} (${typeLabel})`);
            }
          }

          totalDeleted += deleted;
          totalKept += kept;

          // localStorageã«ä¿å­˜
          localStorage.setItem(key, JSON.stringify(resetEmployees));
          log(`${factoryNames[i]}: å‰Šé™¤${deleted}åã€ä¿æŒ${kept}å â†’ åˆè¨ˆ${resetEmployees.length}å`);

          // Firebaseã«ã‚‚ä¿å­˜
          if (db) {
            try {
              await db.ref('factories/' + i + '/employees').set(resetEmployees);
              log(`  FirebaseåŒæœŸå®Œäº†`);
            } catch (e) {
              log(`  [è­¦å‘Š] FirebaseåŒæœŸã‚¨ãƒ©ãƒ¼: ${e.message}`, true);
            }
          } else {
            log(`  [è­¦å‘Š] Firebaseã¯æœªæ¥ç¶š (localStorage ã®ã¿æ›´æ–°)`);
          }
        }

        // ãƒªã‚»ãƒƒãƒˆæ™‚åˆ»ã‚’è¨˜éŒ²
        const now = new Date().toISOString();
        const nowJST = new Date().toLocaleString('ja-JP');
        localStorage.setItem('heater-last-reset', now);
        if (db) {
          try {
            await db.ref('settings/lastReset').set(now);
          } catch (e) {
            log(`ãƒªã‚»ãƒƒãƒˆæ™‚åˆ»ã®Firebaseä¿å­˜ã‚¨ãƒ©ãƒ¼: ${e.message}`, true);
          }
        }

        log(`\n[å®Œäº†] æ‰‹å‹•ãƒªã‚»ãƒƒãƒˆå®Œäº†!`);
        log(`å®Ÿè¡Œæ—¥æ™‚: ${nowJST}`);
        log(`åˆè¨ˆ: å‰Šé™¤${totalDeleted}åã€ä¿æŒ${totalKept}å`);
        updateStatus('[å®Œäº†] æ‰‹å‹•ãƒªã‚»ãƒƒãƒˆå®Œäº†', true);

        setTimeout(() => {
          alert('ãƒªã‚»ãƒƒãƒˆå®Œäº†ã—ã¾ã—ãŸã€‚\n\nãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚’é–‹ã„ã¦ã„ã‚‹å ´åˆã¯ã€\nãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆæ›´æ–°ï¼‰ã—ã¦ãã ã•ã„ã€‚');
        }, 500);

      } catch (error) {
        log('[ã‚¨ãƒ©ãƒ¼] ' + error.message, true);
        console.error('Detailed error:', error);
        updateStatus('[ã‚¨ãƒ©ãƒ¼] ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', false);
      }
    }

    async function checkStatus() {
      log('ğŸ“Š ç¾åœ¨ã®çŠ¶æ…‹ã‚’ç¢ºèªä¸­...');

      const lastReset = localStorage.getItem('heater-last-reset');
      log(`æœ€çµ‚ãƒªã‚»ãƒƒãƒˆæ—¥æ™‚: ${lastReset || 'æœªè¨­å®š'}`);

      const factoryNames = ['ç¬¬ä¸€å·¥å ´', 'ç¬¬äºŒå·¥å ´', 'ç¬¬ä¸‰å·¥å ´', 'ç¬¬å››å·¥å ´'];
      for (let i = 0; i < 4; i++) {
        const local = localStorage.getItem('heater-employees-' + i);
        const localData = local ? JSON.parse(local) : [];
        log(`${factoryNames[i]}: ${localData.length}å`);

        if (db) {
          const snapshot = await db.ref('factories/' + i + '/employees').once('value');
          const firebaseData = snapshot.val() || [];
          log(`  â”” Firebase: ${firebaseData.length}å`);
        }
      }

      log('âœ… çŠ¶æ…‹ç¢ºèªå®Œäº†');
    }

    // åˆæœŸçŠ¶æ…‹ç¢ºèª
    window.addEventListener('load', () => {
      log('ç®¡ç†ç”»é¢ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
      log('æº–å‚™å®Œäº†');
    });
  </script>
</body>
</html>
