<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®¡ç†ç”»é¢ - ç¯æ²¹ã‚¹ãƒˆãƒ¼ãƒ–æ¶ˆç«ç¢ºèªã‚¢ãƒ—ãƒª</title>

  <!-- Authentication -->
  <script src="./auth.js"></script>

  <style>
    /* ============================================
       CSS Variables - index.htmlã¨çµ±ä¸€
       ============================================ */
    :root {
      --primary-red: #f43f5e;
      --primary-red-dark: #e11d48;
      --primary-red-light: #fb7185;
      --accent-orange: #fb923c;
      --accent-yellow: #fbbf24;
      --success-green: #10b981;
      --success-green-dark: #059669;
      --info-blue: #3b82f6;
      --info-blue-light: #60a5fa;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;

      --bg-gradient-start: #fff1f2;
      --bg-gradient-end: #ffe4e6;

      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);

      --transition-fast: 150ms ease-in-out;
      --transition-normal: 300ms ease-in-out;
      --transition-slow: 500ms ease-in-out;
    }

    /* ============================================
       Reset & Base Styles
       ============================================ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
      background-attachment: fixed;
      min-height: 100vh;
      padding: 20px;
      color: var(--gray-800);
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    /* ============================================
       Header
       ============================================ */
    .header-card {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 16px;
      box-shadow: var(--shadow-md);
      padding: 24px;
      margin-bottom: 24px;
      transition: all var(--transition-normal);
    }

    .header-card:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }

    .header-content {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .admin-icon {
      background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-red-dark) 100%);
      padding: 16px;
      border-radius: 12px;
      font-size: 28px;
      box-shadow: 0 4px 12px rgba(244, 63, 94, 0.3);
      animation: pulse-glow 2s ease-in-out infinite;
    }

    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 4px 12px rgba(244, 63, 94, 0.3); }
      50% { box-shadow: 0 4px 20px rgba(244, 63, 94, 0.5); }
    }

    h1 {
      font-size: 26px;
      color: var(--gray-900);
      font-weight: 700;
      margin-bottom: 4px;
    }

    .subtitle {
      font-size: 14px;
      color: var(--gray-500);
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      margin-top: 12px;
    }

    .status-badge.success {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      color: #065f46;
    }

    .status-badge.warning {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      color: #92400e;
    }

    /* ============================================
       Dashboard Grid
       ============================================ */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 16px;
      box-shadow: var(--shadow-md);
      padding: 20px;
      transition: all var(--transition-normal);
    }

    .stat-card:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }

    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .stat-title {
      font-size: 14px;
      color: var(--gray-600);
      font-weight: 600;
    }

    .stat-icon {
      font-size: 20px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 8px;
    }

    .stat-label {
      font-size: 13px;
      color: var(--gray-500);
    }

    .stat-breakdown {
      display: flex;
      gap: 12px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--gray-200);
    }

    .stat-item {
      flex: 1;
      text-align: center;
    }

    .stat-item-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--gray-800);
    }

    .stat-item-label {
      font-size: 11px;
      color: var(--gray-500);
      margin-top: 4px;
    }

    /* ============================================
       Cards
       ============================================ */
    .card {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 16px;
      box-shadow: var(--shadow-md);
      padding: 24px;
      margin-bottom: 20px;
      transition: all var(--transition-normal);
    }

    .card:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }

    .card-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ============================================
       Buttons
       ============================================ */
    .btn-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    .btn {
      padding: 14px 20px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      font-size: 15px;
      transition: all var(--transition-fast);
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
    }

    .btn-danger:hover {
      box-shadow: 0 6px 16px rgba(239, 68, 68, 0.3);
    }

    .btn-warning {
      background: linear-gradient(135deg, var(--accent-yellow) 0%, var(--accent-orange) 100%);
      color: white;
    }

    .btn-warning:hover {
      box-shadow: 0 6px 16px rgba(251, 191, 36, 0.3);
    }

    .btn-info {
      background: linear-gradient(135deg, var(--info-blue) 0%, var(--info-blue-light) 100%);
      color: white;
    }

    .btn-info:hover {
      box-shadow: 0 6px 16px rgba(59, 130, 246, 0.3);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success-green) 0%, var(--success-green-dark) 100%);
      color: white;
    }

    .btn-success:hover {
      box-shadow: 0 6px 16px rgba(16, 185, 129, 0.3);
    }

    .btn-secondary {
      background: linear-gradient(135deg, var(--gray-600) 0%, var(--gray-700) 100%);
      color: white;
    }

    /* ============================================
       Factory Selectors
       ============================================ */
    .factory-selectors {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .factory-card {
      background: rgba(255, 255, 255, 0.6);
      border: 2px solid var(--gray-200);
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all var(--transition-fast);
      text-align: center;
    }

    .factory-card:hover {
      background: rgba(255, 255, 255, 0.9);
      border-color: var(--info-blue);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .factory-card.selected {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      border-color: var(--info-blue);
      box-shadow: var(--shadow-md);
    }

    .factory-name {
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: 8px;
    }

    .factory-stats {
      font-size: 12px;
      color: var(--gray-600);
    }

    /* ============================================
       Timeline (X/Twitter Style)
       ============================================ */
    .timeline-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 16px;
      max-height: 600px;
      overflow-y: auto;
      padding-right: 8px;
    }

    .timeline-container::-webkit-scrollbar {
      width: 8px;
    }

    .timeline-container::-webkit-scrollbar-track {
      background: var(--gray-100);
      border-radius: 10px;
    }

    .timeline-container::-webkit-scrollbar-thumb {
      background: var(--gray-300);
      border-radius: 10px;
    }

    .timeline-container::-webkit-scrollbar-thumb:hover {
      background: var(--gray-400);
    }

    .timeline-item {
      background: rgba(255, 255, 255, 0.7);
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 16px;
      transition: all var(--transition-fast);
      display: flex;
      gap: 12px;
    }

    .timeline-item:hover {
      background: rgba(255, 255, 255, 0.95);
      border-color: var(--gray-300);
      box-shadow: var(--shadow);
      transform: translateX(2px);
    }

    .timeline-icon {
      flex-shrink: 0;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      box-shadow: var(--shadow-sm);
    }

    .timeline-icon.type-add {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    }

    .timeline-icon.type-reuse {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    }

    .timeline-icon.type-delete {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    }

    .timeline-icon.type-check {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    }

    .timeline-icon.type-uncheck {
      background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
    }

    .timeline-icon.type-reset {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    }

    .timeline-icon.type-final-check {
      background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
    }

    .timeline-content {
      flex: 1;
      min-width: 0;
    }

    .timeline-header {
      display: flex;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 4px;
      flex-wrap: wrap;
    }

    .timeline-action {
      font-weight: 600;
      color: var(--gray-900);
      font-size: 14px;
    }

    .timeline-factory {
      font-size: 13px;
      color: var(--gray-600);
      font-weight: 500;
    }

    .timeline-employee {
      font-size: 14px;
      color: var(--gray-800);
      margin-top: 4px;
    }

    .timeline-timestamp {
      font-size: 12px;
      color: var(--gray-500);
      margin-top: 4px;
    }

    .timeline-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 4px;
    }

    .timeline-badge.permanent {
      background: rgba(59, 130, 246, 0.15);
      color: var(--info-blue);
    }

    .timeline-badge.temporary {
      background: rgba(251, 191, 36, 0.15);
      color: var(--accent-orange);
    }

    .timeline-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--gray-500);
    }

    .timeline-filters {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 8px 16px;
      border: 2px solid var(--gray-200);
      background: white;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
      color: var(--gray-600);
    }

    .filter-btn:hover {
      border-color: var(--info-blue);
      color: var(--info-blue);
    }

    .filter-btn.active {
      background: var(--info-blue);
      border-color: var(--info-blue);
      color: white;
    }

    /* ============================================
       Warning Modal
       ============================================ */
    .modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      animation: fadeIn 0.2s ease-out;
    }

    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--shadow-xl);
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        transform: translateY(50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .warning-modal {
      border: 3px solid var(--primary-red);
    }

    .warning-header {
      background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-red-dark) 100%);
      padding: 24px;
      text-align: center;
      border-radius: 13px 13px 0 0;
    }

    .warning-icon {
      font-size: 64px;
      margin-bottom: 12px;
      animation: shake 0.5s ease-in-out;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    .warning-title {
      font-size: 24px;
      font-weight: 700;
      color: white;
      margin: 0;
    }

    .warning-body {
      padding: 24px;
    }

    .warning-message {
      font-size: 16px;
      color: var(--gray-800);
      line-height: 1.6;
      margin-bottom: 20px;
    }

    .warning-details {
      background: var(--gray-100);
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .warning-detail-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--gray-200);
    }

    .warning-detail-item:last-child {
      border-bottom: none;
    }

    .warning-detail-label {
      font-weight: 600;
      color: var(--gray-700);
    }

    .warning-detail-value {
      color: var(--primary-red);
      font-weight: 700;
    }

    .warning-actions {
      display: flex;
      gap: 12px;
    }

    .warning-btn {
      flex: 1;
      padding: 14px 20px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .warning-btn-cancel {
      background: var(--gray-200);
      color: var(--gray-700);
    }

    .warning-btn-cancel:hover {
      background: var(--gray-300);
    }

    .warning-btn-confirm {
      background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-red-dark) 100%);
      color: white;
    }

    .warning-btn-confirm:hover {
      box-shadow: 0 6px 16px rgba(244, 63, 94, 0.4);
      transform: translateY(-2px);
    }

    /* ============================================
       Responsive
       ============================================ */
    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }

      .btn-group {
        grid-template-columns: 1fr;
      }

      .factory-selectors {
        grid-template-columns: repeat(2, 1fr);
      }

      .timeline-item {
        padding: 12px;
      }

      .timeline-icon {
        width: 36px;
        height: 36px;
        font-size: 16px;
      }
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="./firebase-config.js"></script>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header-card">
      <div class="header-content">
        <div class="admin-icon">âš™ï¸</div>
        <div style="flex: 1;">
          <h1>ç®¡ç†ç”»é¢</h1>
          <p class="subtitle">ç¯æ²¹ã‚¹ãƒˆãƒ¼ãƒ–æ¶ˆç«ç¢ºèªã‚¢ãƒ—ãƒª - çµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </p>
          <div id="statusBadge" class="status-badge warning">
            <span>ğŸ”„</span>
            <span>æ¥ç¶šç¢ºèªä¸­...</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Statistics Dashboard -->
    <div class="dashboard-grid" id="dashboardGrid"></div>

    <!-- Settings Section -->
    <div class="card">
      <h2 class="card-title">âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</h2>
      <div style="margin-bottom: 20px;">
        <label style="display: block; color: var(--gray-700); font-weight: 600; margin-bottom: 8px;">
          ğŸ• è‡ªå‹•ãƒªã‚»ãƒƒãƒˆæ™‚åˆ»
        </label>
        <p style="color: var(--gray-600); font-size: 13px; margin-bottom: 12px;">
          æ¯æ—¥ã“ã®æ™‚åˆ»ä»¥é™ã«è‡ªå‹•ãƒªã‚»ãƒƒãƒˆãŒå®Ÿè¡Œã•ã‚Œã¾ã™
        </p>
        <div style="display: flex; gap: 12px; align-items: center;">
          <select id="resetHourSelect" style="padding: 8px 12px; border-radius: 8px; border: 1px solid var(--gray-300); font-size: 14px;">
            <option value="0">AM 0:00</option>
            <option value="1">AM 1:00</option>
            <option value="2">AM 2:00</option>
            <option value="3">AM 3:00</option>
            <option value="4">AM 4:00</option>
            <option value="5" selected>AM 5:00</option>
            <option value="6">AM 6:00</option>
            <option value="7">AM 7:00</option>
            <option value="8">AM 8:00</option>
            <option value="9">AM 9:00</option>
            <option value="10">AM 10:00</option>
            <option value="11">AM 11:00</option>
            <option value="12">PM 12:00</option>
            <option value="13">PM 1:00</option>
            <option value="14">PM 2:00</option>
            <option value="15">PM 3:00</option>
            <option value="16">PM 4:00</option>
            <option value="17">PM 5:00</option>
            <option value="18">PM 6:00</option>
            <option value="19">PM 7:00</option>
            <option value="20">PM 8:00</option>
            <option value="21">PM 9:00</option>
            <option value="22">PM 10:00</option>
            <option value="23">PM 11:00</option>
          </select>
          <button class="btn btn-primary" onclick="saveResetTime()">
            ğŸ’¾ ä¿å­˜
          </button>
        </div>
        <p id="resetTimeStatus" style="color: var(--gray-600); font-size: 12px; margin-top: 8px;">
          ç¾åœ¨ã®è¨­å®š: AM 5:00
        </p>
      </div>
    </div>

    <!-- Factory Reset Section -->
    <div class="card">
      <h2 class="card-title">ğŸ­ å·¥å ´åˆ¥ãƒªã‚»ãƒƒãƒˆ</h2>
      <p style="color: var(--gray-600); font-size: 14px; margin-bottom: 16px;">
        ãƒªã‚»ãƒƒãƒˆã—ãŸã„å·¥å ´ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰
      </p>
      <div class="factory-selectors" id="factorySelectors"></div>
      <div class="btn-group">
        <button class="btn btn-warning" onclick="resetSelectedFactories()">
          ğŸ”„ é¸æŠã—ãŸå·¥å ´ã‚’ãƒªã‚»ãƒƒãƒˆ
        </button>
        <button class="btn btn-info" onclick="refreshDashboard()">
          ğŸ”„ ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
        </button>
      </div>
    </div>

    <!-- System Actions -->
    <div class="card">
      <h2 class="card-title">ğŸ› ï¸ ã‚·ã‚¹ãƒ†ãƒ æ“ä½œ</h2>
      <div class="btn-group">
        <button class="btn btn-warning" onclick="manualResetAll()">
          ğŸ”„ å…¨å·¥å ´ã‚’æ‰‹å‹•ãƒªã‚»ãƒƒãƒˆ
        </button>
        <button class="btn btn-danger" onclick="forceResetAll()">
          ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨å‰Šé™¤
        </button>
        <button class="btn btn-success" onclick="backupData()">
          ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
        </button>
        <button class="btn btn-secondary" onclick="window.open('./index.html', '_blank')">
          ğŸ  ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚’é–‹ã
        </button>
      </div>
    </div>

    <!-- Activity Timeline -->
    <div class="card">
      <h2 class="card-title">ğŸ“± ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h2>
      <p style="color: var(--gray-600); font-size: 14px; margin-bottom: 16px;">
        ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã§è¡Œã‚ã‚ŒãŸå…¨ã¦ã®æ“ä½œå±¥æ­´
      </p>

      <div class="timeline-filters" id="timelineFilters">
        <button class="filter-btn active" onclick="filterTimeline('all')">å…¨ã¦</button>
        <button class="filter-btn" onclick="filterTimeline('add')">è¿½åŠ </button>
        <button class="filter-btn" onclick="filterTimeline('reuse')">å†ä½¿ç”¨</button>
        <button class="filter-btn" onclick="filterTimeline('delete')">å‰Šé™¤</button>
        <button class="filter-btn" onclick="filterTimeline('check')">ãƒã‚§ãƒƒã‚¯</button>
        <button class="filter-btn" onclick="filterTimeline('final-check')">æœ€çµ‚ç¢ºèª</button>
        <button class="filter-btn" onclick="filterTimeline('reset')">ãƒªã‚»ãƒƒãƒˆ</button>
      </div>

      <div class="timeline-container" id="timelineContainer">
        <div class="timeline-empty">
          <div style="font-size: 48px; margin-bottom: 12px;">ğŸ“­</div>
          <div>ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
      </div>
    </div>

  </div>

  <!-- Warning Modal -->
  <div id="warningModal" class="modal">
    <div class="modal-content warning-modal">
      <div id="warningModalContent"></div>
    </div>
  </div>

  <script>
    let db = null;
    const factoryNames = ['ç¬¬ä¸€å·¥å ´', 'ç¬¬äºŒå·¥å ´', 'ç¬¬ä¸‰å·¥å ´', 'ç¬¬å››å·¥å ´'];
    let selectedFactories = new Set();
    let allData = {};

    // ============================================
    // Warning Modal
    // ============================================
    function showWarningModal(config) {
      return new Promise((resolve) => {
        const modal = document.getElementById('warningModal');
        const content = document.getElementById('warningModalContent');

        let detailsHtml = '';
        if (config.details && config.details.length > 0) {
          detailsHtml = '<div class="warning-details">';
          for (const detail of config.details) {
            detailsHtml += `
              <div class="warning-detail-item">
                <span class="warning-detail-label">${detail.label}</span>
                <span class="warning-detail-value">${detail.value}</span>
              </div>
            `;
          }
          detailsHtml += '</div>';
        }

        content.innerHTML = `
          <div class="warning-header">
            <div class="warning-icon">${config.icon || 'âš ï¸'}</div>
            <h2 class="warning-title">${config.title}</h2>
          </div>
          <div class="warning-body">
            <p class="warning-message">${config.message}</p>
            ${detailsHtml}
            <div class="warning-actions">
              <button class="warning-btn warning-btn-cancel" onclick="closeWarningModal(false)">
                ${config.cancelText || 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'}
              </button>
              <button class="warning-btn warning-btn-confirm" onclick="closeWarningModal(true)">
                ${config.confirmText || 'å®Ÿè¡Œã™ã‚‹'}
              </button>
            </div>
          </div>
        `;

        modal.classList.add('show');

        // Store resolve function globally
        window._warningModalResolve = resolve;
      });
    }

    function closeWarningModal(confirmed) {
      const modal = document.getElementById('warningModal');
      modal.classList.remove('show');

      if (window._warningModalResolve) {
        window._warningModalResolve(confirmed);
        window._warningModalResolve = null;
      }
    }

    // ============================================
    // Utility Functions
    // ============================================
    function log(msg, type = 'info') {
      const icons = {
        info: 'ğŸ“˜',
        success: 'âœ…',
        warning: 'âš ï¸',
        error: 'âŒ'
      };
      const icon = icons[type] || 'ğŸ“˜';
      console.log(`${icon} ${msg}`);
    }

    function updateStatus(msg, isSuccess = true) {
      const badge = document.getElementById('statusBadge');
      badge.innerHTML = `
        <span>${isSuccess ? 'âœ…' : 'âš ï¸'}</span>
        <span>${msg}</span>
      `;
      badge.className = 'status-badge ' + (isSuccess ? 'success' : 'warning');
    }

    // ============================================
    // Data Loading
    // ============================================
    async function loadAllData() {
      allData = {};
      for (let i = 0; i < 4; i++) {
        const key = 'heater-employees-' + i;
        const saved = localStorage.getItem(key);
        allData[i] = saved ? JSON.parse(saved) : [];
      }
    }

    // ============================================
    // Dashboard
    // ============================================
    async function refreshDashboard() {
      log('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’æ›´æ–°ä¸­...');
      await loadAllData();

      const grid = document.getElementById('dashboardGrid');
      grid.innerHTML = '';

      let totalEmployees = 0;
      let totalChecked = 0;
      let totalPermanent = 0;
      let totalTemporary = 0;

      for (let i = 0; i < 4; i++) {
        const employees = allData[i] || [];
        const checked = employees.filter(e => e.checked).length;
        const permanent = employees.filter(e => e.type === 'permanent').length;
        const temporary = employees.filter(e => e.type === 'temporary').length;

        totalEmployees += employees.length;
        totalChecked += checked;
        totalPermanent += permanent;
        totalTemporary += temporary;

        const card = document.createElement('div');
        card.className = 'stat-card';
        card.innerHTML = `
          <div class="stat-header">
            <span class="stat-title">${factoryNames[i]}</span>
            <span class="stat-icon">ğŸ­</span>
          </div>
          <div class="stat-value">${employees.length}<span style="font-size: 18px; color: var(--gray-500);">å</span></div>
          <div class="stat-label">ç™»éŒ²ç¤¾å“¡æ•°</div>
          <div class="stat-breakdown">
            <div class="stat-item">
              <div class="stat-item-value" style="color: var(--success-green);">${checked}</div>
              <div class="stat-item-label">ç¢ºèªæ¸ˆ</div>
            </div>
            <div class="stat-item">
              <div class="stat-item-value" style="color: var(--info-blue);">${permanent}</div>
              <div class="stat-item-label">è¿½åŠ </div>
            </div>
            <div class="stat-item">
              <div class="stat-item-value" style="color: var(--accent-orange);">${temporary}</div>
              <div class="stat-item-label">å†ä½¿ç”¨</div>
            </div>
          </div>
        `;
        grid.appendChild(card);
      }

      // Summary Card
      const summaryCard = document.createElement('div');
      summaryCard.className = 'stat-card';
      summaryCard.style.background = 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)';
      summaryCard.innerHTML = `
        <div class="stat-header">
          <span class="stat-title">å…¨å·¥å ´åˆè¨ˆ</span>
          <span class="stat-icon">ğŸ“Š</span>
        </div>
        <div class="stat-value">${totalEmployees}<span style="font-size: 18px; color: var(--gray-600);">å</span></div>
        <div class="stat-label">ç·ç™»éŒ²ç¤¾å“¡æ•°</div>
        <div class="stat-breakdown">
          <div class="stat-item">
            <div class="stat-item-value" style="color: var(--success-green);">${totalChecked}</div>
            <div class="stat-item-label">ç¢ºèªæ¸ˆ</div>
          </div>
          <div class="stat-item">
            <div class="stat-item-value" style="color: var(--info-blue);">${totalPermanent}</div>
            <div class="stat-item-label">è¿½åŠ </div>
          </div>
          <div class="stat-item">
            <div class="stat-item-value" style="color: var(--accent-orange);">${totalTemporary}</div>
            <div class="stat-item-label">å†ä½¿ç”¨</div>
          </div>
        </div>
      `;
      grid.appendChild(summaryCard);

      renderFactorySelectors();
      renderTimeline(currentFilter);
    }

    // ============================================
    // Factory Selectors
    // ============================================
    function renderFactorySelectors() {
      const container = document.getElementById('factorySelectors');
      container.innerHTML = '';

      for (let i = 0; i < 4; i++) {
        const employees = allData[i] || [];
        const card = document.createElement('div');
        card.className = 'factory-card' + (selectedFactories.has(i) ? ' selected' : '');
        card.onclick = () => toggleFactory(i);
        card.innerHTML = `
          <div class="factory-name">${factoryNames[i]}</div>
          <div class="factory-stats">${employees.length}åç™»éŒ²</div>
        `;
        container.appendChild(card);
      }
    }

    function toggleFactory(index) {
      if (selectedFactories.has(index)) {
        selectedFactories.delete(index);
      } else {
        selectedFactories.add(index);
      }
      renderFactorySelectors();
    }

    // ============================================
    // Reset Functions
    // ============================================
    async function resetSelectedFactories() {
      if (selectedFactories.size === 0) {
        alert('ãƒªã‚»ãƒƒãƒˆã™ã‚‹å·¥å ´ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      const factoryList = Array.from(selectedFactories).map(i => factoryNames[i]).join('ã€');

      // çµ±è¨ˆæƒ…å ±ã‚’è¨ˆç®—
      let totalEmployees = 0;
      let totalTemporary = 0;
      for (const i of selectedFactories) {
        const employees = allData[i] || [];
        totalEmployees += employees.length;
        totalTemporary += employees.filter(e => e.type === 'temporary').length;
      }

      const confirmed = await showWarningModal({
        icon: 'ğŸ”„',
        title: 'é¸æŠã—ãŸå·¥å ´ã‚’ãƒªã‚»ãƒƒãƒˆ',
        message: `ä»¥ä¸‹ã®å·¥å ´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`,
        details: [
          { label: 'å¯¾è±¡å·¥å ´', value: factoryList },
          { label: 'ç™»éŒ²ç¤¾å“¡æ•°', value: `${totalEmployees}å` },
          { label: 'å‰Šé™¤ã•ã‚Œã‚‹ç¤¾å“¡', value: `${totalTemporary}åï¼ˆå†ä½¿ç”¨ï¼‰` },
          { label: 'ç¶­æŒã•ã‚Œã‚‹ç¤¾å“¡', value: `${totalEmployees - totalTemporary}åï¼ˆè¿½åŠ ï¼‰` }
        ],
        confirmText: 'ãƒªã‚»ãƒƒãƒˆã‚’å®Ÿè¡Œ',
        cancelText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'
      });

      if (!confirmed) {
        log('ãƒªã‚»ãƒƒãƒˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
        return;
      }

      log(`é¸æŠã—ãŸå·¥å ´ã®ãƒªã‚»ãƒƒãƒˆã‚’é–‹å§‹: ${factoryList}`, 'info');

      let totalDeleted = 0;
      let totalKept = 0;

      for (const i of selectedFactories) {
        const employees = allData[i] || [];
        const resetEmployees = [];
        let deleted = 0;
        let kept = 0;

        for (const emp of employees) {
          if (emp.type === 'temporary') {
            deleted++;
            log(`  [å‰Šé™¤] ${factoryNames[i]} - ${emp.name}`, 'warning');
          } else {
            emp.checked = false;
            resetEmployees.push(emp);
            kept++;
          }
        }

        allData[i] = resetEmployees;
        localStorage.setItem('heater-employees-' + i, JSON.stringify(resetEmployees));

        if (db) {
          try {
            await db.ref('factories/' + i + '/employees').set(resetEmployees);
          } catch (e) {
            log(`FirebaseåŒæœŸã‚¨ãƒ©ãƒ¼: ${factoryNames[i]}`, 'error');
          }
        }

        totalDeleted += deleted;
        totalKept += kept;
        log(`${factoryNames[i]}: å‰Šé™¤${deleted}åã€ä¿æŒ${kept}å`, 'success');
      }

      log(`ãƒªã‚»ãƒƒãƒˆå®Œäº† - åˆè¨ˆ: å‰Šé™¤${totalDeleted}åã€ä¿æŒ${totalKept}å`, 'success');
      selectedFactories.clear();
      await refreshDashboard();
    }

    async function manualResetAll() {
      // çµ±è¨ˆæƒ…å ±ã‚’è¨ˆç®—
      let totalEmployees = 0;
      let totalTemporary = 0;
      for (let i = 0; i < 4; i++) {
        const employees = allData[i] || [];
        totalEmployees += employees.length;
        totalTemporary += employees.filter(e => e.type === 'temporary').length;
      }

      const confirmed = await showWarningModal({
        icon: 'ğŸ”„',
        title: 'å…¨å·¥å ´ã‚’æ‰‹å‹•ãƒªã‚»ãƒƒãƒˆ',
        message: `å…¨å·¥å ´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`,
        details: [
          { label: 'å¯¾è±¡å·¥å ´', value: 'å…¨4å·¥å ´' },
          { label: 'ç™»éŒ²ç¤¾å“¡æ•°', value: `${totalEmployees}å` },
          { label: 'å‰Šé™¤ã•ã‚Œã‚‹ç¤¾å“¡', value: `${totalTemporary}åï¼ˆå†ä½¿ç”¨ï¼‰` },
          { label: 'ç¶­æŒã•ã‚Œã‚‹ç¤¾å“¡', value: `${totalEmployees - totalTemporary}åï¼ˆè¿½åŠ ï¼‰` }
        ],
        confirmText: 'å…¨å·¥å ´ã‚’ãƒªã‚»ãƒƒãƒˆ',
        cancelText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'
      });

      if (!confirmed) {
        log('å…¨å·¥å ´ãƒªã‚»ãƒƒãƒˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
        return;
      }

      log('å…¨å·¥å ´ã®æ‰‹å‹•ãƒªã‚»ãƒƒãƒˆé–‹å§‹', 'info');

      let totalDeleted = 0;
      let totalKept = 0;

      for (let i = 0; i < 4; i++) {
        const employees = allData[i] || [];
        const resetEmployees = [];
        let deleted = 0;
        let kept = 0;

        for (const emp of employees) {
          if (emp.type === 'temporary') {
            deleted++;
          } else {
            emp.checked = false;
            resetEmployees.push(emp);
            kept++;
          }
        }

        allData[i] = resetEmployees;
        localStorage.setItem('heater-employees-' + i, JSON.stringify(resetEmployees));

        if (db) {
          try {
            await db.ref('factories/' + i + '/employees').set(resetEmployees);
          } catch (e) {
            log(`FirebaseåŒæœŸã‚¨ãƒ©ãƒ¼: ${factoryNames[i]}`, 'error');
          }
        }

        totalDeleted += deleted;
        totalKept += kept;
        log(`${factoryNames[i]}: å‰Šé™¤${deleted}åã€ä¿æŒ${kept}å`, 'success');
      }

      // ãƒªã‚»ãƒƒãƒˆæ™‚åˆ»ã‚’è¨˜éŒ²
      const now = new Date().toDateString();
      localStorage.setItem('heater-last-reset', now);
      if (db) {
        await db.ref('settings/lastReset').set(now);
      }

      log(`å…¨å·¥å ´ãƒªã‚»ãƒƒãƒˆå®Œäº† - åˆè¨ˆ: å‰Šé™¤${totalDeleted}åã€ä¿æŒ${totalKept}å`, 'success');
      await refreshDashboard();
    }

    async function forceResetAll() {
      // çµ±è¨ˆæƒ…å ±ã‚’è¨ˆç®—
      let totalEmployees = 0;
      for (let i = 0; i < 4; i++) {
        const employees = allData[i] || [];
        totalEmployees += employees.length;
      }

      const resetHistory = JSON.parse(localStorage.getItem('heater-reset-history') || '[]');
      const activityHistory = JSON.parse(localStorage.getItem('heater-activity-history') || '[]');

      // ç¬¬ä¸€æ®µéšï¼šãƒ‡ãƒ¼ã‚¿ã®æ¦‚è¦ã‚’è¡¨ç¤º
      const confirmed1 = await showWarningModal({
        icon: 'ğŸ—‘ï¸',
        title: 'å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨å‰Šé™¤',
        message: `ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚<br><strong style="color: var(--primary-red);">ã“ã®æ“ä½œã¯çµ¶å¯¾ã«å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ï¼</strong>`,
        details: [
          { label: 'å‰Šé™¤ã•ã‚Œã‚‹ç¤¾å“¡', value: `${totalEmployees}åï¼ˆå…¨å·¥å ´ï¼‰` },
          { label: 'å‰Šé™¤ã•ã‚Œã‚‹ãƒªã‚»ãƒƒãƒˆå±¥æ­´', value: `${resetHistory.length}ä»¶` },
          { label: 'å‰Šé™¤ã•ã‚Œã‚‹æ“ä½œå±¥æ­´', value: `${activityHistory.length}ä»¶` },
          { label: 'å½±éŸ¿ç¯„å›²', value: 'å…¨å·¥å ´ãƒ»å…¨ãƒ‡ãƒ¼ã‚¿' }
        ],
        confirmText: 'æ¬¡ã¸é€²ã‚€',
        cancelText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'
      });

      if (!confirmed1) {
        log('å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
        return;
      }

      // ç¬¬äºŒæ®µéšï¼šæœ€çµ‚ç¢ºèªï¼ˆã‚ˆã‚Šå¼·ã„è­¦å‘Šï¼‰
      const confirmed2 = await showWarningModal({
        icon: 'âš ï¸',
        title: 'æœ€çµ‚ç¢ºèª',
        message: `<strong style="font-size: 18px; color: var(--primary-red);">æœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ</strong><br><br>ã“ã®æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€${totalEmployees}åã®ç¤¾å“¡ãƒ‡ãƒ¼ã‚¿ã€${resetHistory.length}ä»¶ã®ãƒªã‚»ãƒƒãƒˆå±¥æ­´ã€${activityHistory.length}ä»¶ã®æ“ä½œå±¥æ­´ãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚<br><br><strong>ã‚‚ã†ä¸€åº¦ã‚ˆãç¢ºèªã—ã¦ãã ã•ã„ã€‚</strong>`,
        details: [],
        confirmText: 'å®Œå…¨ã«å‰Šé™¤ã™ã‚‹',
        cancelText: 'ã‚„ã‚ã‚‹'
      });

      if (!confirmed2) {
        log('å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸï¼ˆæœ€çµ‚ç¢ºèªï¼‰');
        return;
      }

      log('å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤é–‹å§‹', 'warning');

      for (let i = 0; i < 4; i++) {
        localStorage.removeItem('heater-employees-' + i);
        if (db) {
          await db.ref('factories/' + i + '/employees').set([]);
        }
        log(`${factoryNames[i]}ã‚’å‰Šé™¤`, 'warning');
      }

      localStorage.removeItem('heater-last-reset');
      localStorage.removeItem('heater-reset-history');
      if (db) {
        await db.ref('settings/lastReset').remove();
      }

      log('å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤å®Œäº†', 'success');
      await refreshDashboard();
      alert('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚\n\nãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
    }

    function backupData() {
      const backup = {
        timestamp: new Date().toISOString(),
        factories: allData,
        lastReset: localStorage.getItem('heater-last-reset'),
        history: JSON.parse(localStorage.getItem('heater-reset-history') || '[]')
      };

      const dataStr = JSON.stringify(backup, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `heater-backup-${new Date().toISOString().slice(0, 10)}.json`;
      link.click();

      log('ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ', 'success');
    }

    // ============================================
    // Settings Functions
    // ============================================

    function saveResetTime() {
      const select = document.getElementById('resetHourSelect');
      const resetHour = parseInt(select.value);

      // Save to localStorage and Firebase
      localStorage.setItem('heater-reset-hour', resetHour);

      if (db) {
        db.ref('settings/resetHour').set(resetHour);
      }

      // Update status display
      updateResetTimeDisplay(resetHour);

      log(`è‡ªå‹•ãƒªã‚»ãƒƒãƒˆæ™‚åˆ»ã‚’ ${getTimeLabel(resetHour)} ã«è¨­å®šã—ã¾ã—ãŸ`, 'success');

      // Show success message
      const status = document.getElementById('resetTimeStatus');
      status.style.color = 'var(--primary-green)';
      status.textContent = `âœ… ä¿å­˜ã—ã¾ã—ãŸ: ${getTimeLabel(resetHour)}`;

      setTimeout(() => {
        status.style.color = 'var(--gray-600)';
        status.textContent = `ç¾åœ¨ã®è¨­å®š: ${getTimeLabel(resetHour)}`;
      }, 3000);
    }

    function loadResetTime() {
      let resetHour = localStorage.getItem('heater-reset-hour');

      if (resetHour === null) {
        resetHour = 5; // Default to 5:00 AM
        localStorage.setItem('heater-reset-hour', resetHour);
      } else {
        resetHour = parseInt(resetHour);
      }

      // Set select value
      const select = document.getElementById('resetHourSelect');
      if (select) {
        select.value = resetHour;
      }

      // Update display
      updateResetTimeDisplay(resetHour);

      // Sync with Firebase
      if (db) {
        db.ref('settings/resetHour').on('value', function(snapshot) {
          const firebaseResetHour = snapshot.val();
          if (firebaseResetHour !== null && firebaseResetHour !== resetHour) {
            localStorage.setItem('heater-reset-hour', firebaseResetHour);
            if (select) {
              select.value = firebaseResetHour;
            }
            updateResetTimeDisplay(firebaseResetHour);
            log(`è‡ªå‹•ãƒªã‚»ãƒƒãƒˆæ™‚åˆ»ã‚’åŒæœŸ: ${getTimeLabel(firebaseResetHour)}`, 'info');
          }
        });
      }
    }

    function updateResetTimeDisplay(hour) {
      const status = document.getElementById('resetTimeStatus');
      if (status) {
        status.textContent = `ç¾åœ¨ã®è¨­å®š: ${getTimeLabel(hour)}`;
      }
    }

    function getTimeLabel(hour) {
      if (hour === 0) return 'AM 0:00 (æ·±å¤œ)';
      if (hour < 12) return `AM ${hour}:00`;
      if (hour === 12) return 'PM 12:00 (æ­£åˆ)';
      return `PM ${hour - 12}:00`;
    }

    // ============================================
    // Activity Timeline
    // ============================================
    let currentFilter = 'all';
    let lastActivityCount = 0;

    function getActivityIcon(type) {
      const icons = {
        'add': 'â•',
        'reuse': 'ğŸ”„',
        'delete': 'ğŸ—‘ï¸',
        'check': 'âœ…',
        'uncheck': 'â¬œ',
        'reset': 'ğŸ”ƒ',
        'final-check': 'ğŸ¯'
      };
      return icons[type] || 'ğŸ“Œ';
    }

    function getActivityText(activity) {
      const typeText = {
        'add': 'ç¤¾å“¡ã‚’è¿½åŠ ',
        'reuse': 'ç¤¾å“¡ã‚’å†ä½¿ç”¨',
        'delete': 'ç¤¾å“¡ã‚’å‰Šé™¤',
        'check': 'ç¢ºèªã‚’ãƒã‚§ãƒƒã‚¯',
        'uncheck': 'ç¢ºèªã‚’è§£é™¤',
        'reset': 'ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ',
        'final-check': 'æœ€çµ‚ç¢ºèª'
      };
      return typeText[activity.type] || 'æ“ä½œ';
    }

    function formatRelativeTime(timestamp) {
      const time = new Date(timestamp);
      const year = time.getFullYear();
      const month = String(time.getMonth() + 1).padStart(2, '0');
      const day = String(time.getDate()).padStart(2, '0');
      const hours = String(time.getHours()).padStart(2, '0');
      const minutes = String(time.getMinutes()).padStart(2, '0');

      return `${year}.${month}.${day} ${hours}:${minutes}`;
    }

    function renderTimeline(filter = 'all') {
      currentFilter = filter;
      const container = document.getElementById('timelineContainer');
      const history = JSON.parse(localStorage.getItem('heater-activity-history') || '[]');

      console.log(`ğŸ¯ renderTimeline called: filter=${filter}, history count=${history.length}`);

      // Update filter buttons based on currentFilter
      const filterButtons = document.querySelectorAll('.filter-btn');
      filterButtons.forEach((btn, index) => {
        btn.classList.remove('active');
        const btnFilterType = btn.textContent.trim();
        const filterMap = {
          'å…¨ã¦': 'all',
          'è¿½åŠ ': 'add',
          'å†ä½¿ç”¨': 'reuse',
          'å‰Šé™¤': 'delete',
          'ãƒã‚§ãƒƒã‚¯': 'check',
          'æœ€çµ‚ç¢ºèª': 'final-check',
          'ãƒªã‚»ãƒƒãƒˆ': 'reset'
        };
        if (filterMap[btnFilterType] === currentFilter) {
          btn.classList.add('active');
        }
      });

      // Filter activities
      let filteredHistory = history;
      if (filter !== 'all') {
        filteredHistory = history.filter(activity => {
          if (filter === 'check') {
            return activity.type === 'check' || activity.type === 'uncheck';
          }
          return activity.type === filter;
        });
      }

      console.log(`ğŸ“Š Filtered history: ${filteredHistory.length} items`);

      if (filteredHistory.length === 0) {
        console.log('âš ï¸ No items to display');
        container.innerHTML = `
          <div class="timeline-empty">
            <div style="font-size: 48px; margin-bottom: 12px;">ğŸ“­</div>
            <div>${filter === 'all' ? 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“' : 'ãƒ•ã‚£ãƒ«ã‚¿ã«ä¸€è‡´ã™ã‚‹å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“'}</div>
          </div>
        `;
        return;
      }

      console.log('âœ… Rendering timeline items...');

      let html = '';
      for (const activity of filteredHistory) {
        const icon = getActivityIcon(activity.type);
        const actionText = getActivityText(activity);
        const relativeTime = formatRelativeTime(activity.timestamp);

        // Determine if this is a check/uncheck action
        const isCheckAction = activity.type === 'check' || activity.type === 'uncheck';

        // æœ€çµ‚ç¢ºèªã®çµæœè¡¨ç¤º
        let finalCheckResult = '';
        if (activity.type === 'final-check' && activity.additionalInfo) {
          const info = activity.additionalInfo;
          if (info.success) {
            finalCheckResult = `
              <div class="timeline-employee" style="color: var(--success-green); font-weight: 600;">
                âœ… å®Œäº† - ${info.totalCount}åå…¨å“¡ç¢ºèªæ¸ˆã¿
              </div>
            `;
          } else {
            finalCheckResult = `
              <div class="timeline-employee" style="color: var(--primary-red); font-weight: 600;">
                âš ï¸ æœªå®Œäº† - ${info.uncheckedCount}åæœªç¢ºèª (ç¢ºèªæ¸ˆã¿: ${info.checkedCount}/${info.totalCount}å)
              </div>
            `;
            if (info.uncheckedNames && info.uncheckedNames.length > 0) {
              finalCheckResult += `
                <div style="font-size: 12px; color: var(--gray-600); margin-top: 4px;">
                  æœªç¢ºèª: ${info.uncheckedNames.join(', ')}
                </div>
              `;
            }
          }
        }

        html += `
          <div class="timeline-item">
            <div class="timeline-icon type-${activity.type}">
              ${icon}
            </div>
            <div class="timeline-content">
              <div class="timeline-header">
                <span class="timeline-action">${actionText}</span>
                <span class="timeline-factory">@${activity.factoryName || factoryNames[activity.factory]}</span>
                ${activity.employeeType ? `<span class="timeline-badge ${activity.employeeType}">${activity.employeeType === 'permanent' ? 'è¿½åŠ ' : 'å†ä½¿ç”¨'}</span>` : ''}
              </div>
              ${activity.employeeName ? `<div class="timeline-employee">${activity.employeeName}</div>` : ''}
              ${activity.additionalInfo && activity.additionalInfo.count ? `<div class="timeline-employee">${activity.additionalInfo.count}å</div>` : ''}
              ${finalCheckResult}
              <div class="timeline-timestamp">${relativeTime}</div>
            </div>
          </div>
        `;
      }

      container.innerHTML = html;
      lastActivityCount = history.length;
      console.log(`âœ¨ Timeline rendered successfully: ${filteredHistory.length} items displayed`);
    }

    function filterTimeline(type) {
      renderTimeline(type);
    }

    async function checkForNewActivities() {
      const history = JSON.parse(localStorage.getItem('heater-activity-history') || '[]');
      if (history.length !== lastActivityCount) {
        console.log(`ğŸ“± æ–°ã—ã„ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’æ¤œå‡º: ${lastActivityCount} â†’ ${history.length}`);
        log(`æ–°ã—ã„ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£: ${history.length - lastActivityCount}ä»¶è¿½åŠ `);

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å…¨ä½“ã‚’æ›´æ–°ï¼ˆçµ±è¨ˆã‚«ãƒ¼ãƒ‰ã‚‚æ›´æ–°ï¼‰
        await refreshDashboard();
      }
    }

    function startRealtimeUpdates() {
      // åˆæœŸã‚«ã‚¦ãƒ³ãƒˆã‚’è¨­å®š
      const initialHistory = JSON.parse(localStorage.getItem('heater-activity-history') || '[]');
      lastActivityCount = initialHistory.length;
      console.log(`ğŸ“Š åˆæœŸã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£æ•°: ${lastActivityCount}`);

      // 500ãƒŸãƒªç§’ï¼ˆ0.5ç§’ï¼‰ã”ã¨ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’ãƒã‚§ãƒƒã‚¯
      setInterval(checkForNewActivities, 500);

      // localStorageå¤‰æ›´æ™‚ã«å³åº§ã«åæ˜ ï¼ˆåˆ¥ã‚¿ãƒ–/ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‹ã‚‰ã®å¤‰æ›´ã‚’æ¤œçŸ¥ï¼‰
      window.addEventListener('storage', async function(e) {
        if (e.key === 'heater-activity-history' || e.key && e.key.startsWith('heater-employees-')) {
          console.log('ğŸ“± storage event detected:', e.key);
          await refreshDashboard();
          log('ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ã‚’æ¤œå‡ºã—ã¾ã—ãŸï¼ˆstorage eventï¼‰');
        }
      });

      // åŒä¸€ãƒšãƒ¼ã‚¸å†…ã®å¤‰æ›´ã‚‚æ¤œçŸ¥ï¼ˆã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆï¼‰
      window.addEventListener('activityUpdated', async function() {
        console.log('ğŸ“± activityUpdated event detected');
        await refreshDashboard();
      });

      window.addEventListener('dataUpdated', async function() {
        console.log('ğŸ“± dataUpdated event detected');
        await refreshDashboard();
      });

      log('ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚’é–‹å§‹ã—ã¾ã—ãŸï¼ˆå³æ™‚åæ˜  + 0.5ç§’é–“éš”ãƒã‚§ãƒƒã‚¯ï¼‰');
    }

    // ============================================
    // Initialize
    // ============================================
    window.addEventListener('load', async () => {
      log('ç®¡ç†ç”»é¢ã‚’èµ·å‹•ã—ã¾ã—ãŸ');

      // FirebaseåˆæœŸåŒ–
      if (typeof initFirebase === 'function') {
        try {
          initFirebase();
          if (typeof getDatabase === 'function') {
            db = getDatabase();
            updateStatus('Firebaseæ¥ç¶šæˆåŠŸ', true);
            log('FirebaseåˆæœŸåŒ–å®Œäº†', 'success');
          }
        } catch (e) {
          updateStatus('ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰', false);
          log('Firebaseæ¥ç¶šå¤±æ•— - ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œ', 'warning');
        }
      } else {
        updateStatus('ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰', false);
        log('Firebaseæœªè¨­å®š - ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œ', 'warning');
      }

      // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åˆæœŸåŒ–
      await refreshDashboard();

      // ãƒªã‚»ãƒƒãƒˆæ™‚åˆ»è¨­å®šã‚’ãƒ­ãƒ¼ãƒ‰
      loadResetTime();

      // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚’é–‹å§‹
      startRealtimeUpdates();

      log('ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†', 'success');
    });

    // Service Worker Registration with Auto-Update
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js')
        .then(function(registration) {
          console.log('âœ… Service Worker registered:', registration.scope);

          // æ›´æ–°ã‚’ãƒã‚§ãƒƒã‚¯
          registration.update();

          // æ–°ã—ã„Service WorkerãŒå¾…æ©Ÿä¸­ã®å ´åˆã€è‡ªå‹•çš„ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–ã—ã¦ãƒªãƒ­ãƒ¼ãƒ‰
          if (registration.waiting) {
            console.log('ğŸ”„ æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’é©ç”¨ä¸­...');
            registration.waiting.postMessage({ type: 'SKIP_WAITING' });
          }

          // æ–°ã—ã„Service WorkerãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸã‚‰é€šçŸ¥
          registration.addEventListener('updatefound', function() {
            var newWorker = registration.installing;
            console.log('ğŸ“¥ æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...');

            newWorker.addEventListener('statechange', function() {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                // æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸ
                console.log('âœ¨ æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™...');
                newWorker.postMessage({ type: 'SKIP_WAITING' });
              }
            });
          });
        })
        .catch(function(error) {
          console.log('âŒ Service Workerç™»éŒ²å¤±æ•—:', error);
        });

      // Service WorkerãŒæ›´æ–°ã•ã‚Œã¦ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ãªã£ãŸã‚‰ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
      var refreshing = false;
      navigator.serviceWorker.addEventListener('controllerchange', function() {
        if (!refreshing) {
          refreshing = true;
          console.log('ğŸ”„ ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦æœ€æ–°ç‰ˆã‚’è¡¨ç¤ºã—ã¾ã™...');
          window.location.reload();
        }
      });
    }
  </script>
</body>
</html>
